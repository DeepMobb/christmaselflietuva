<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalƒód≈≥ elfai ‚Äì 2025</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom animation for the raffle */
        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); opacity: 1; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 0.8; }
            100% { transform: rotate(360deg) scale(1); opacity: 1; }
        }
        .animate-raffle {
            animation: spin 1.5s ease-in-out; /* Run once, not infinite */
        }

        /* Modal transitions for smooth appearance */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.hidden {
            pointer-events: none;
            opacity: 0;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* CSS for loading screen fade-out */
        #loading-screen {
            transition: opacity 1s ease-out;
        }
        #loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-950 z-[100] flex flex-col items-center justify-center">
        <div id="loading-spinner" class="text-7xl animate-pulse">üéÑ</div>
        <h1 class="text-3xl font-extrabold text-green-400 mt-4">Kalƒód≈≥ elfai</h1>
        <p id="loading-text" class="text-gray-400 text-sm">Rengiant rogƒós...</p>
    </div>

    <!-- Main container -->
    <div class="max-w-md mx-auto min-h-screen flex flex-col">
        
        <!-- Header Section -->
        <header class="p-4 border-b border-gray-800 bg-gray-950/80 backdrop-blur-sm sticky top-0 z-10">
            <h1 class="text-3xl font-extrabold text-green-400">Kalƒód≈≥ elfai</h1>
            <p class="text-gray-400 text-sm">Kam b≈´si slaptas Kalƒód≈≥ elfas?</p>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4">
            
            <!-- Card 1: Select Your Name (Default) -->
            <div id="selection-card" class="bg-gray-900 rounded-xl shadow-md shadow-green-900/10 p-4 hidden">
                <label for="name-select" class="block text-sm font-medium text-gray-300 mb-2">Koks tavo vardas?</label>
                <select id="name-select" class="w-full bg-gray-800 border-gray-700 text-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition p-3">
                    <option value="">-- Pasirink savo vardƒÖ --</option>
                    <!-- Options will be dynamically populated -->
                </select>
                <button 
                    id="assign-button"
                    class="w-full mt-4 bg-green-500 text-gray-950 font-bold text-lg py-3 rounded-full shadow-lg shadow-green-500/20 hover:bg-green-400 transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled
                >
                    Spausk ir su≈æinosi‚ú®
                </button>
            </div>

            <!-- Card 2: Show Assignment (After selection) -->
            <div id="assignment-card" class="bg-gray-900 rounded-xl shadow-md shadow-green-900/10 p-6 text-center hidden">
                <p class="text-gray-400 text-lg">Tu esi Kalƒód≈≥ elfƒó...</p>
                <div id="assignment-animation" class="my-6 flex justify-center hidden">
                    <div class="text-7xl animate-raffle">üéÅ</div>
                </div>
                <div id="assignment-result" class="hidden">
                    <p id="receiver-icon" class="text-7xl mt-4">üéÑ</p>
                    <p id="receiver-name" class="text-4xl font-extrabold text-teal-400 mt-2">...</p>
                    <p class="text-gray-500 text-sm mt-6">Sƒókmingo dovan≈≥ rinkimo! Turƒótumƒóte rasti dovanƒÖ, kuri, j≈´s≈≥ manymu, padaryt≈≥ tƒÖ ≈æmog≈≥ laimingƒÖ.</p>
                </div>
            </div>

            <!-- Card 3: All assignments done -->
            <div id="all-done-card" class="bg-gray-900 rounded-xl shadow-md shadow-green-900/10 p-6 text-center hidden">
                <p class="text-7xl">üéâ</p>
                <p class="text-2xl font-bold text-green-400 mt-4">All Elves Assigned!</p>
                <p class="text-gray-400 text-lg mt-2">Everyone has a person to gift to. Check with the admin if you need a reset.</p>
            </div>

        </main>

        <!-- Sticky Footer / Action Bar -->
        <footer class="sticky bottom-0 bg-gray-900 p-4 border-t border-gray-800 shadow-inner hidden">
            <!-- This button is no longer used -->
        </footer>
    </div>


    <!-- Admin Reset Icon Button -->
    <button 
        id="admin-reset-button"
        class="fixed bottom-6 right-6 bg-gray-700 text-gray-300 p-3 rounded-full shadow-lg hover:bg-gray-600 hover:text-white transition-all duration-300 z-20"
        aria-label="Admin Reset"
    >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM11.906 15.003c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM10.343 21.003c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM3.498 8.61c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM3.498 15.61c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM20.502 8.61c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM20.502 15.61c.09-.542.56-1.007 1.11-.1.09.542-.56 1.007-1.11.1zM17.61 4.706a.75.75 0 0 0-1.06 0l-1.414 1.414a.75.75 0 0 0 1.06 1.06l1.414-1.414a.75.75 0 0 0 0-1.06zM6.39 4.706a.75.75 0 0 1 0 1.06L4.975 7.182a.75.75 0 0 1-1.06-1.06L4.975 4.706a.75.75 0 0 1 1.06 0zM17.61 19.294a.75.75 0 0 0-1.06 0l-1.414 1.414a.75.75 0 0 0 1.06 1.06l1.414-1.414a.75.75 0 0 0 0-1.06zM6.39 19.294a.75.75 0 0 1 0 1.06L4.975 21.77a.75.75 0 0 1-1.06-1.06L4.975 19.294a.75.75 0 0 1 1.06 0zM12 7.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9z" />
        </svg>
    </button>


    <!-- PIN Code Modal -->
    <div id="pin-modal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-900 rounded-2xl shadow-xl w-full max-w-sm p-6 relative border border-gray-700">
            <!-- Close Button -->
            <button id="pin-modal-close-button" class="absolute top-3 right-3 text-gray-500 hover:text-gray-300 transition" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-xl font-bold text-center text-green-400">Admin Reset</h2>
            <p class="text-center text-gray-400 text-sm mt-1">Enter PIN to reset all assignments.</p>
            
            <input 
                type="password" 
                id="pin-input" 
                inputmode="numeric"
                class="w-full text-center text-2xl tracking-widest bg-gray-800 border-gray-700 text-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition p-3 mt-4"
                maxlength="4"
            >
            <div id="pin-error" class="text-red-500 text-center text-sm mt-2 h-4"></div>
            <button 
                id="pin-submit-button"
                class="w-full mt-2 bg-red-600 text-white font-bold py-3 rounded-full hover:bg-red-500 transition"
            >
                Confirm Reset
            </button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PRE-DEFINED DATA ---
        // This list will be used to 'seed' the database the first time the app is run.
        const PREDEFINED_PARTICIPANTS = [
            { id: 1, name: 'Milda', icon: 'üéÑ' },
            { id: 2, name: 'Vytautas', icon: 'üéÅ' },
            { id: 3, name: 'Enrika', icon: 'ü¶å' },
            { id: 4, name: 'Erik', icon: 'üçÅ' },
            { id: 5, name: 'Lukas', icon: '‚òÉÔ∏è' },
            { id: 6, name: 'Elija', icon: 'üéÖ' },
            { id: 7, name: 'Regina', icon: 'ü§∂' },
            { id: 8, name: 'Viktor', icon: 'üîî' },
            { id: 9, name: 'Monika', icon: 'üéÑ' },
            { id: 10, name: 'Hans', icon: 'üéÅ' }
        ];

        // --- DOM ELEMENTS ---
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const selectionCard = document.getElementById('selection-card');
        const assignmentCard = document.getElementById('assignment-card');
        const allDoneCard = document.getElementById('all-done-card');
        const nameSelect = document.getElementById('name-select');
        const assignButton = document.getElementById('assign-button');
        const assignmentAnimation = document.getElementById('assignment-animation');
        const assignmentResult = document.getElementById('assignment-result');
        const receiverIcon = document.getElementById('receiver-icon');
        const receiverName = document.getElementById('receiver-name');
        const resetButton = document.getElementById('admin-reset-button');
        
        const pinModal = document.getElementById('pin-modal');
        const pinModalCloseButton = document.getElementById('pin-modal-close-button');
        const pinInput = document.getElementById('pin-input');
        const pinError = document.getElementById('pin-error');
        const pinSubmitButton = document.getElementById('pin-submit-button');

        // --- FIREBASE & APP STATE ---
        let app, auth, db;
        let userId;
        let raffleDocRef;
        let myGiverId = null;
        let appState = {
            participants: [],
            assignments: []
        };

        // --- INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Show loading screen
            setTimeout(() => {
                loadingScreen.classList.add('fade-out');
                setTimeout(() => loadingScreen.style.display = 'none', 1000);
            }, 5000); // Original 5-second load

            // 2. Init Firebase
            try {
                // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // No longer needed for GitHub
                // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); // Old way
                
                // --- 1. PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
                // You get this from your project settings in the Firebase Console
                const firebaseConfig = {
                  apiKey: "AIzaSyCefDJ1crR268D_kWRnojQwu89Bt3YKsLk",
                  authDomain: "christmas-elf-622ab.firebaseapp.com",
                  projectId: "christmas-elf-622ab",
                  storageBucket: "christmas-elf-622ab.firebasestorage.app",
                  messagingSenderId: "185221288883",
                  appId: "1:185221288883:web:cb6892b023c6c586a4b1c6"
                };
                // --- END OF CONFIG ---

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                
                // --- 2. UPDATE THE DATABASE PATH ---
                // This creates a simpler path in your new database
                raffleDocRef = doc(db, 'raffle', 'main');

                // 3. Sign in
                loadingText.textContent = 'Autenti≈°kumo patvirtinimas...';
                // Since this code is for GitHub, we will always sign in anonymously.
                // The __initial_auth_token is only for the Canvas environment.
                try {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                    console.log('Authenticated user:', userId);
                } catch (authError) {
                    console.error("Anonymous sign-in failed:", authError);
                    loadingText.textContent = 'Authentication failed. Please enable anonymous sign-in in your Firebase project.';
                    loadingSpinner.textContent = 'üîí';
                    loadingSpinner.classList.remove('animate-pulse');
                    throw authError; // Stop execution if auth fails
                }

                // 4. Check local storage
                myGiverId = getMyAssignmentFromStorage();

                // 5. Seed DB if needed
                loadingText.textContent = 'I≈°renkamas sƒÖra≈°as...';
                await seedDatabaseIfNeeded();

                // 6. Set up real-time listener
                onSnapshot(raffleDocRef, (doc) => {
                    console.log('Raffle data updated');
                    if (doc.exists()) {
                        // --- FIX ---
                        // Ensure appState always has the correct shape
                        const data = doc.data();
                        appState = {
                            participants: data.participants || [],
                            assignments: data.assignments || []
                        };
                        // --- END FIX ---
                        renderApp();
                    } else {
                        console.error('Raffle document does not exist!');
                    }
                });

            } catch (error) {
                console.error('Initialization failed:', error);
                // Check if the error is the one we threw manually
                if (error.message && error.message.includes("Anonymous sign-in failed")) {
                    // Auth error already handled, do nothing
                } else {
                    loadingText.textContent = 'Error connecting to the sleigh.';
                    loadingSpinner.classList.remove('animate-pulse');
                    loadingSpinner.textContent = '‚ùå';
                }
            }

            // 7. Add event listeners
            setupEventListeners();
        });

        /**
         * Checks if the database has been seeded with participants. If not, seeds it.
         */
        async function seedDatabaseIfNeeded() {
            const docSnap = await getDoc(raffleDocRef);
            if (!docSnap.exists()) {
                console.log('No raffle data found. Seeding database...');
                loadingText.textContent = 'Building the workshop...';
                await setDoc(raffleDocRef, {
                    participants: PREDEFINED_PARTICIPANTS,
                    assignments: []
                });
                console.log('Database seeded.');
            } else {
                console.log('Raffle data found.');
                // OPTIONAL: Check if participant list is different and update
                const dbParticipants = docSnap.data().participants;
                if (JSON.stringify(dbParticipants) !== JSON.stringify(PREDEFINED_PARTICIPANTS)) {
                    console.log('Participant list mismatch. Updating database list.');
                    // Be careful with this in production, as it could wipe assignments
                    // For this app, we assume resetting assignments is OK if the list changes.
                    await updateDoc(raffleDocRef, {
                        participants: PREDEFINED_PARTICIPANTS,
                        assignments: [] // Reset assignments if participant list changes
                    });
                    // Clear local storage as assignments are invalid
                    clearMyAssignmentFromStorage();
                    myGiverId = null;
                }
            }
        }

        /**
         * Main render function, called on load and on data updates.
         */
        function renderApp() {
            console.log('Rendering app state:', appState);
            // Check if user has already been assigned
            myGiverId = getMyAssignmentFromStorage();
            if (myGiverId) {
                // Check if this assignment is still valid
                const myAssignment = appState.assignments.find(a => a.giverId === myGiverId);
                if (myAssignment) {
                    showMyAssignment();
                } else {
                    // Assignment was reset
                    console.warn('Assignment no longer in DB. Clearing storage.');
                    clearMyAssignmentFromStorage();
                    myGiverId = null;
                    populateDropdown();
                    showCard(selectionCard);
                }
            } else {
                // User has not been assigned, show selection
                populateDropdown();
                showCard(selectionCard);
            }
        }

        /**
         * Populates the dropdown with *available* givers.
         */
        function populateDropdown() {
            const assignedGiverIds = new Set(appState.assignments.map(a => a.giverId));
            const availableParticipants = appState.participants.filter(p => !assignedGiverIds.has(p.id));

            nameSelect.innerHTML = '<option value="">-- Pasirinkite savo vardƒÖ --</option>'; // Reset
            
            if (availableParticipants.length === 0 && appState.participants.length > 0) {
                // All assignments are done
                showCard(allDoneCard);
            } else {
                availableParticipants.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.icon} ${p.name}`;
                    nameSelect.appendChild(option);
                });
                showCard(selectionCard);
            }
        }

        /**
         * Finds and displays the user's assignment.
         * @param {boolean} isNew - Should we play the animation?
         * @param {object | null} receiverData - Pre-fetched receiver data (to bypass appState race condition)
         */
        function showMyAssignment(isNew = false, receiverData = null) {
            let receiver = receiverData;

            if (!receiver) {
                // This is the "normal" flow, e.g., on page load
                const myAssignment = appState.assignments.find(a => a.giverId === myGiverId);
                if (!myAssignment) {
                    console.warn('I have a giverId in storage, but no assignment in DB. Clearing storage.');
                    clearMyAssignmentFromStorage();
                    renderApp(); // Re-render
                    return;
                }
                receiver = appState.participants.find(p => p.id === myAssignment.receiverId);
            }
            
            if (!receiver) {
                console.error('Assignment found, but receiver data is missing! This may happen if the participant list was changed.');
                // Clear bad data and reset
                clearMyAssignmentFromStorage();
                renderApp();
                return;
            }

            showCard(assignmentCard);

            if (isNew) {
                // Show animation
                assignmentResult.classList.add('hidden');
                assignmentAnimation.classList.remove('hidden');
                setTimeout(() => {
                    receiverIcon.textContent = receiver.icon;
                    receiverName.textContent = receiver.name;
                    assignmentAnimation.classList.add('hidden');
                    assignmentResult.classList.remove('hidden');
                }, 1500); // Match animation time
            } else {
                // Just show result
                receiverIcon.textContent = receiver.icon;
                receiverName.textContent = receiver.name;
                assignmentAnimation.classList.add('hidden');
                assignmentResult.classList.remove('hidden');
            }
        }

        /**
         * Handles the "See who you are an elf to" button click.
         */
        async function handleAssignElf() {
            const selectedGiverId = parseInt(nameSelect.value);
            if (!selectedGiverId) return;

            assignButton.disabled = true;
            assignButton.textContent = 'Paskirstymas...';

            let finalReceiverId = null; // <-- Variable to store the chosen receiver's ID

            try {
                // Use a Firestore Transaction to prevent race conditions
                await runTransaction(db, async (transaction) => {
                    const raffleDoc = await transaction.get(raffleDocRef);
                    if (!raffleDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const currentData = raffleDoc.data();
                    
                    // --- FIX: Ensure participants and assignments are arrays ---
                    const participants = currentData.participants || [];
                    const assignments = currentData.assignments || [];
                    // --- END FIX ---

                    // 1. Find all assigned receiver IDs
                    const assignedReceiverIds = new Set(assignments.map(a => a.receiverId));
                    // 2. Find all assigned giver IDs (to double-check)
                    const assignedGiverIds = new Set(assignments.map(a => a.giverId));

                    // 3. Check if this giver is already taken
                    if (assignedGiverIds.has(selectedGiverId)) {
                        throw "This name has already been taken. Please refresh.";
                    }
                    
                    // 4. Find all *available* receivers
                    const availableReceiverIds = participants
                        .map(p => p.id)
                        .filter(id => id !== selectedGiverId && !assignedReceiverIds.has(id));

                    if (availableReceiverIds.length === 0) {
                        // Check if the only person left is the user themselves
                        const allReceiverIds = new Set(participants.map(p => p.id));
                        const unassignedReceivers = new Set(
                            [...allReceiverIds].filter(id => !assignedReceiverIds.has(id))
                        );

                        if (unassignedReceivers.size === 1 && unassignedReceivers.has(selectedGiverId)) {
                            // --- FIX: Last person is stuck, so we must swap assignments ---
                            console.log("Last person is stuck. Attempting to swap...");

                            if (assignments.length === 0) {
                                // This should be impossible if we're the last person
                                throw "Last person is stuck, but there are no assignments to swap with.";
                            }
                            
                            // 1. Pick a random assignment to swap with.
                            const swapIndex = Math.floor(Math.random() * assignments.length);
                            const assignmentToSwap = assignments[swapIndex];
                            
                            // 2. The new receiver for the last person is the receiver from the swapped assignment.
                            const newReceiverForLastPerson = assignmentToSwap.receiverId;
                            finalReceiverId = newReceiverForLastPerson; // <-- Store the receiver ID
                            
                            // 3. The new receiver for the swapped assignment is the last person (the giver).
                            const newReceiverForSwappedGiver = selectedGiverId;
                            
                            // 4. Create the new assignment for the last person.
                            const newAssignment = {
                                giverId: selectedGiverId,
                                receiverId: finalReceiverId // <-- Use the stored ID
                            };
                            
                            // 5. Update the swapped assignment *in the array*.
                            assignments[swapIndex].receiverId = newReceiverForSwappedGiver;
                            
                            // 6. Update the document in the transaction
                            // The 'assignments' array now has the modified swap AND we add the new assignment.
                            transaction.update(raffleDocRef, {
                                assignments: [...assignments, newAssignment] 
                            });

                            // 7. Save to local storage
                            myGiverId = selectedGiverId;
                            saveMyAssignmentToStorage(myGiverId);
                            // --- END FIX ---

                        } else {
                             // This is a different error
                             throw "No available receivers left for an unknown reason.";
                        }
                    } else {
                        // --- This is the normal flow (not the last person) ---
                        // 5. Randomly pick one
                        const randomReceiverId = availableReceiverIds[Math.floor(Math.random() * availableReceiverIds.length)];
                        finalReceiverId = randomReceiverId; // <-- Store the receiver ID

                        // 6. Create new assignment
                        const newAssignment = {
                            giverId: selectedGiverId,
                            receiverId: finalReceiverId // <-- Use the stored ID
                        };
                        
                        // 7. Update the document in the transaction
                        transaction.update(raffleDocRef, {
                            assignments: [...assignments, newAssignment]
                        });

                        // 8. Save to local storage and state
                        myGiverId = selectedGiverId;
                        saveMyAssignmentToStorage(myGiverId);
                    }
                });

                // Success! Transaction committed.
                // Now we can immediately show the result because we saved the receiver's ID.
                
                myGiverId = selectedGiverId;
                saveMyAssignmentToStorage(myGiverId);

                // Find the receiver's data from our (stable) participants list
                const receiver = appState.participants.find(p => p.id === finalReceiverId);

                if (receiver) {
                    // Pass the receiver data directly to showMyAssignment to skip the race condition
                    showMyAssignment(true, receiver);
                } else {
                    // This is a fallback, onSnapshot will catch this anyway
                    console.error("Transaction succeeded but couldn't find receiver data to display!");
                    // The onSnapshot listener will eventually update and render the app.
                }

            } catch (error) {
                console.error("Transaction failed: ", error);
                // Use a simple, non-blocking notification instead of alert()
                const originalError = error.message || error.toString();
                if (originalError.includes("alert")) {
                    console.error("Original error contained 'alert', which is blocked.");
                } else {
                     // Check if a custom non-blocking alert can be shown
                     // For now, log to console and reset button
                }
                console.error("Assignment error:", originalError);
                assignButton.disabled = false;
                assignButton.textContent = 'See who you are an elf to';
            }
        }

        /**
         * Handles the "Admin Reset" button click.
         */
        async function handleReset() {
            const pin = pinInput.value;
            if (pin !== "1909") {
                pinError.textContent = "Incorrect PIN.";
                return;
            }

            pinError.textContent = "";
            pinSubmitButton.disabled = true;
            pinSubmitButton.textContent = "Resetting...";

            try {
                // Update Firestore: set assignments to an empty array
                await updateDoc(raffleDocRef, {
                    assignments: []
                });

                // Clear local storage
                clearMyAssignmentFromStorage();
                myGiverId = null;

                console.log('Raffle has been reset.');
                closePinModal();
                // onSnapshot will automatically re-render the app to the selection state
            } catch (error) {
                console.error("Failed to reset raffle: ", error);
                pinError.textContent = "Reset failed. Try again.";
            } finally {
                pinSubmitButton.disabled = false;
                pinSubmitButton.textContent = "Confirm Reset";
                pinInput.value = "";
            }
        }

        // --- UTILITY FUNCTIONS ---
        function setupEventListeners() {
            nameSelect.addEventListener('change', () => {
                assignButton.disabled = !nameSelect.value;
            });
            assignButton.addEventListener('click', handleAssignElf);
            resetButton.addEventListener('click', () => pinModal.classList.remove('hidden'));
            pinModalCloseButton.addEventListener('click', closePinModal);
            pinModal.addEventListener('click', (e) => {
                if (e.target === pinModal) closePinModal();
            });
            pinSubmitButton.addEventListener('click', handleReset);
        }

        function closePinModal() {
            pinModal.classList.add('hidden');
            pinInput.value = "";
            pinError.textContent = "";
        }

        function showCard(cardToShow) {
            [selectionCard, assignmentCard, allDoneCard].forEach(card => {
                card.classList.add('hidden');
            });
            cardToShow.classList.remove('hidden');
        }

        function saveMyAssignmentToStorage(giverId) {
            localStorage.setItem('christmasElfGiverId', giverId.toString());
        }

        function getMyAssignmentFromStorage() {
            const id = localStorage.getItem('christmasElfGiverId');
            return id ? parseInt(id) : null;
        }

        function clearMyAssignmentFromStorage() {
            localStorage.removeItem('christmasElfGiverId');
        }

    </script>
</body>
</html>












